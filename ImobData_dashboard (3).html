<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ImobData</title>
  <style>
    :root{
      --bg0:#020D10;
      --bg1:#031A1F;
      --card:#072C32;
      --card2:#08353D;
      --stroke:rgba(255,255,255,.09);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --pool:#0aa6b4;
      --lime:#B6FF00;
      --orange:#FF7A00;
      --pos:#30E37A;
      --neg:#FF4D4D;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(10,166,180,.14), transparent 60%),
        radial-gradient(900px 600px at 85% 10%, rgba(255,122,0,.10), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(182,255,0,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{ color:inherit; }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 18px 34px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 10px 8px 18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 240px;
    }
    .logo{
      width: 42px; height:42px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(10,166,180,.95), rgba(182,255,0,.55));
      box-shadow: 0 10px 24px rgba(10,166,180,.22);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(2,13,16,.75), rgba(3,26,31,.20));
      border: 1px solid rgba(255,255,255,.12);
    }
    .brand h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.3px;
      font-weight: 700;
    }
    .month{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .4px;
      text-transform: none;
      margin: 0;
      padding: 0 6px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 12px;
      flex: 1;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(7,44,50,.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      min-width: 280px;
      max-width: 460px;
      width: 100%;
    }
    .pill input{
      width: 100%;
      border:none;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size: 14px;
      letter-spacing:.2px;
    }
    .pill input::placeholder{ color: rgba(255,255,255,.55); }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 5px 8px;
      border-radius: 10px;
      flex:0 0 auto;
    }
    .icon{
      width: 18px; height: 18px; flex:0 0 auto;
      color: rgba(255,255,255,.65);
    }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Table */
    .card{
      background: linear-gradient(180deg, rgba(7,44,50,.80), rgba(8,53,61,.55));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .table-wrap{
      width:100%;
      overflow:auto;
    }
    table{
      border-collapse: collapse;
      width: 100%;
      min-width: 920px;
      color: var(--text);
      font-size: 13px;
    }
    thead th{
      position: sticky;
      top: 0;
      background: rgba(3,26,31,.92);
      backdrop-filter: blur(10px);
      padding: 14px 14px;
      text-align:left;
      border-bottom: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    thead th .sort{
      margin-left: 8px;
      font-size: 11px;
      opacity:.75;
    }
    tbody td{
      padding: 13px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      white-space:nowrap;
    }
    tbody tr{
      transition: background .15s ease, transform .08s ease;
      cursor:pointer;
    }
    tbody tr:hover{
      background: rgba(10,166,180,.12);
    }
    tbody tr:active{
      transform: scale(0.999);
    }
    .muted{ color: var(--muted); }
    .pos{ color: var(--pos) !important; font-weight: 700; }
    .neg{ color: var(--neg) !important; font-weight: 700; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .dot{
      width:8px; height:8px;
      border-radius: 50%;
      background: var(--pool);
      box-shadow: 0 0 0 3px rgba(10,166,180,.12);
    }

    /* Detail */
    .detail-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin: 10px 0 14px;
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .btn:hover{
      background: rgba(10,166,180,.10);
      border-color: rgba(10,166,180,.25);
    }
    .btn:active{ transform: translateY(1px); }
    .btn .arrow{
      width: 16px; height:16px;
      display:inline-block;
      border-left: 2px solid rgba(255,255,255,.8);
      border-bottom: 2px solid rgba(255,255,255,.8);
      transform: rotate(45deg);
      margin-right: 2px;
    }
    .detail-title{
      font-size: 18px;
      margin: 0;
      font-weight: 800;
      letter-spacing: .4px;
    }

    .grid{
      display:grid;
      gap: 12px;
    }
    .grid.top{
      grid-template-columns: 1.35fr 0.85fr 0.85fr;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .grid.top{ grid-template-columns: 1fr; }
      table{ min-width: 720px; }
      header{ flex-direction:column; align-items:stretch; }
      .topbar{ justify-content:space-between; }
      .brand{ min-width: 0; }
      .month{ text-align:left; padding-left: 8px; }
    }

    .metric-card{
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(7,44,50,.82), rgba(8,53,61,.52));
      box-shadow: var(--shadow);
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 88px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .metric-card:before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: inherit;
      background: radial-gradient(500px 150px at 20% 0%, rgba(10,166,180,.25), transparent 55%),
                  radial-gradient(500px 150px at 100% 100%, rgba(255,122,0,.18), transparent 55%);
      pointer-events:none;
      opacity:.65;
    }
    .metric-card .inner{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      width:100%;
      height:100%;
    }
    .metric-card .label{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      letter-spacing:.35px;
      text-transform: uppercase;
    }
    .metric-card .value{
      font-size: 22px;
      font-weight: 900;
      letter-spacing:.2px;
      line-height: 1.05;
    }
    .metric-card.big .value{
      font-size: 30px;
      letter-spacing: .3px;
    }
    .metric-card.big{
      min-height: 188px;
    }

    .stack{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 12px;
      height: 100%;
    }

    .grid.right{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Summary + chart */
    .section{
      margin-top: 14px;
    }
    .section .title{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing:.2px;
      font-weight: 800;
    }
    .summary{
      padding: 16px 16px 18px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      min-height: 92px;
      color: rgba(255,255,255,.92);
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .chart-card{
      margin-top: 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .chart-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .chart-head .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,166,180,.10);
      color: rgba(255,255,255,.85);
      font-size: 12px;
      white-space:nowrap;
    }
    .chart-area{
      position:relative;
      height: 320px;
      padding: 10px 10px 16px;
    }
    .empty{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 28px;
      color: rgba(255,255,255,.65);
      font-size: 13px;
    }

    /* Tiny tooltip */
    .tooltip{
      position:absolute;
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(3,26,31,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      min-width: 150px;
      transform: translate(-50%,-110%);
      opacity:0;
      transition: opacity .12s ease;
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .tooltip strong{
      display:block;
      font-size: 12px;
      margin-bottom: 3px;
      color: rgba(255,255,255,.90);
    }
    .tooltip .v{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(182,255,0,.95);
    }

    footer{
      margin-top: 18px;
      color: rgba(255,255,255,.45);
      font-size: 12px;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand" aria-label="ImobData">
        <div class="logo" aria-hidden="true"></div>
        <h1>ImobData</h1>
      </div>
      <h2 class="month" id="monthLabel">—</h2>
      <div class="topbar">
        <div class="pill" title="Digite para filtrar. Enter abre o fundo se houver correspondência.">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="search" list="fundList" placeholder="Buscar fundo (ticker/nome)..." autocomplete="off" />
          <span class="kbd">Enter</span>
          <datalist id="fundList"></datalist>
        </div>
      </div>
    </header>

    <!-- HOME -->
    <section id="viewHome" class="view active">
      <div class="card">
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th data-key="fundo">Fundo <span class="sort" id="sort_fundo"></span></th>
                <th data-key="preco">Preço atual <span class="sort" id="sort_preco"></span></th>
                <th data-key="ret_m">Retorno - mês <span class="sort" id="sort_ret_m"></span></th>
                <th data-key="ret_12m">Retorno 12 meses <span class="sort" id="sort_ret_12m"></span></th>
                <th data-key="pvp">P/VP atual <span class="sort" id="sort_pvp"></span></th>
                <th data-key="dy">Dividend Yield a.a. <span class="sort" id="sort_dy"></span></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <footer>ImobData • Dashboard offline em arquivo único</footer>
    </section>

    <!-- DETAIL -->
    <section id="viewDetail" class="view">
      <div class="detail-header">
        <button class="btn" id="btnBack" type="button"><span class="arrow" aria-hidden="true"></span>Voltar</button>
        <h3 class="detail-title" id="detailTitle">—</h3>
        <span></span>
      </div>

      <div class="grid top">
        <!-- Left big price -->
        <div class="metric-card big" id="cardPrice">
          <div class="inner">
            <div class="label">Preço atual</div>
            <div class="value" id="vPrice">—</div>
            <div class="muted" style="font-size:12px;">R$</div>
          </div>
        </div>

        <!-- Middle stacked returns -->
        <div class="stack">
          <div class="metric-card" id="cardRetM">
            <div class="inner">
              <div class="label">Retorno - mês</div>
              <div class="value" id="vRetM">—</div>
            </div>
          </div>
          <div class="metric-card" id="cardRet12M">
            <div class="inner">
              <div class="label">Retorno 12 meses</div>
              <div class="value" id="vRet12M">—</div>
            </div>
          </div>
        </div>

        <!-- Right grid -->
        <div class="grid right">
          <div class="metric-card" id="cardPVP">
            <div class="inner">
              <div class="label">P/VP atual</div>
              <div class="value" id="vPVP">—</div>
            </div>
          </div>

          <div class="stack">
            <div class="metric-card" id="cardDY">
              <div class="inner">
                <div class="label">Dividend Yield a.a.</div>
                <div class="value" id="vDY">—</div>
              </div>
            </div>
            <div class="metric-card" id="cardUltDiv" style="display:none;">
              <div class="inner">
                <div class="label">Último Dividendo Pago</div>
                <div class="value" id="vUltDiv">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h4 class="title" id="summaryTitle">O que aconteceu com o — em —:</h4>
        <div class="summary" id="summaryText">—</div>
      </div>

      <div class="chart-card section">
        <div class="chart-head">
          <div class="left">
            <span class="dot" aria-hidden="true"></span>
            <span>Série diária</span>
          </div>
          <span class="badge" id="badgePoints">0 pontos</span>
        </div>

        <div class="chart-area" id="chartArea">
          <canvas id="chartCanvas" width="900" height="320" aria-label="Gráfico de preços"></canvas>
          <div class="empty" id="chartEmpty" style="display:none;">Sem histórico disponível.</div>
          <div class="tooltip" id="tt">
            <strong id="ttDate">—</strong>
            <div class="v" id="ttVal">—</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // =========================
    // Embedded data (from Excel)
    // =========================
    // NOTE: This file was generated from the workbook sheets "dashboard" and "historico".
    // The generator embeds JSON so the file runs fully offline.

    const __DATA__ = {
      "meta": {
        "mesReferencia": "Janeiro 2026"
      },
      "dashboard": [
        {
          "fundo": "Fundo A",
          "preco": 100,
          "ret_m": 0.0123,
          "ret_12m": 0.1567,
          "pvp": 0.98,
          "dy": 0.1025,
          "resumo": "Resumo exemplo do Fundo A."
        }
      ],
      "historico": {
        "Fundo A": [
          {"data": "2026-01-02", "valor": 98.50},
          {"data": "2026-01-03", "valor": 99.10},
          {"data": "2026-01-06", "valor": 100.00}
        ]
      }
    };

    // =========================
    // Robustness / Normalization
    // =========================

    function toNumber(v){
      if (v === null || v === undefined) return null;
      if (typeof v === 'number') return Number.isFinite(v) ? v : null;
      const s = String(v).trim();
      if (!s) return null;
      // Accept "R$ 12,34", "12.34", "12,34", "10%" etc.
      const cleaned = s
        .replace(/\s/g,'')
        .replace(/R\$/gi,'')
        .replace(/\./g,'')
        .replace(',', '.')
        .replace('%','');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }

    function fmtMoney(n){
      if (n === null || n === undefined || !Number.isFinite(n)) return "—";
      return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtPVP(n){
      if (n === null || n === undefined || !Number.isFinite(n)) return "—";
      return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtPct(n){
      if (n === null || n === undefined || !Number.isFinite(n)) return "—";
      return (n * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
    }
    function signClass(n){
      if (n === null || n === undefined || !Number.isFinite(n)) return "";
      return n >= 0 ? "pos" : "neg";
    }

    function normalizeFundName(s){
      if (!s) return "";
      return String(s).trim();
    }

    // Parse date strings (YYYY-MM-DD or DD/MM/YYYY). Return ISO YYYY-MM-DD
    function toISODate(d){
      if (!d) return null;
      if (d instanceof Date && !isNaN(d)) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }
      const s = String(d).trim();
      if (!s) return null;

      // already ISO
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      // dd/mm/yyyy
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m){
        const dd = m[1], mm = m[2], yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }

      // Excel serial? (e.g., 45234)
      const n = Number(s.replace(',','.'));
      if (Number.isFinite(n) && n > 20000 && n < 80000){
        // Excel serial date: days since 1899-12-30 (Excel's epoch adjustment)
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const dt = new Date(epoch.getTime() + n * 24*3600*1000);
        const yyyy = dt.getUTCFullYear();
        const mm = String(dt.getUTCMonth()+1).padStart(2,'0');
        const dd = String(dt.getUTCDate()).padStart(2,'0');
        return `${yyyy}-${mm}-${dd}`;
      }
      return null;
    }

    // Prepare data
    const metaMonth = (__DATA__.meta && __DATA__.meta.mesReferencia) ? __DATA__.meta.mesReferencia : "—";
    document.getElementById('monthLabel').textContent = metaMonth;

    const dashboardRaw = Array.isArray(__DATA__.dashboard) ? __DATA__.dashboard : [];
    const DASH = dashboardRaw.map((r, idx) => ({
      _id: idx,
      fundo: normalizeFundName(r.fundo ?? r.Fundo ?? r.ticker ?? r.nome ?? ""),
      preco: toNumber(r.preco ?? r["Preço atual"] ?? r.preço ?? r.B),
      ret_m: toNumber(r.ret_m ?? r["Retorno - mês"] ?? r.C),
      ret_12m: toNumber(r.ret_12m ?? r["Retorno 12 meses"] ?? r.D),
      pvp: toNumber(r.pvp ?? r["P/VP atual"] ?? r.E),
      dy: toNumber(r.dy ?? r["Dividend Yield a.a."] ?? r.F),
      resumo: (r.resumo ?? r["Resumo do fundo"] ?? r.G ?? r.H ?? "").toString()
    })).filter(r => r.fundo);

    // Historical: object keyed by fund name/ticker
    const HIST = (__DATA__.historico && typeof __DATA__.historico === 'object') ? __DATA__.historico : {};

    function getHistoryForFund(fundName){
      // exact match
      if (HIST[fundName] && Array.isArray(HIST[fundName])) return HIST[fundName];
      // try case-insensitive match
      const key = Object.keys(HIST).find(k => k.toLowerCase() === fundName.toLowerCase());
      if (key && Array.isArray(HIST[key])) return HIST[key];
      return [];
    }

    // =========================
    // UI: Table, Search, Sort
    // =========================

    const elHome = document.getElementById('viewHome');
    const elDetail = document.getElementById('viewDetail');
    const elSearch = document.getElementById('search');
    const elTbody = document.getElementById('tbody');
    const elFundList = document.getElementById('fundList');

    let state = {
      query: "",
      sortKey: "fundo",
      sortDir: "asc", // asc/desc
      filtered: [...DASH],
      selected: null,
    };

    function fillDatalist(){
      elFundList.innerHTML = "";
      DASH.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.fundo;
        elFundList.appendChild(opt);
      });
    }

    function applyFilter(){
      const q = state.query.trim().toLowerCase();
      if (!q){
        state.filtered = [...DASH];
      } else {
        state.filtered = DASH.filter(r => r.fundo.toLowerCase().includes(q));
      }
      applySort();
    }

    function compare(a,b,key){
      const va = a[key];
      const vb = b[key];
      const na = (typeof va === 'number' && Number.isFinite(va));
      const nb = (typeof vb === 'number' && Number.isFinite(vb));
      if (na && nb) return va - vb;
      return String(va ?? "").localeCompare(String(vb ?? ""), 'pt-BR', { sensitivity:'base' });
    }

    function applySort(){
      const { sortKey, sortDir } = state;
      state.filtered.sort((a,b)=>{
        const c = compare(a,b,sortKey);
        return sortDir === 'asc' ? c : -c;
      });
      renderTable();
      renderSortIcons();
    }

    function renderSortIcons(){
      const keys = ["fundo","preco","ret_m","ret_12m","pvp","dy"];
      keys.forEach(k => {
        const el = document.getElementById('sort_'+k);
        if (!el) return;
        if (state.sortKey !== k) { el.textContent = ""; return; }
        el.textContent = state.sortDir === 'asc' ? "▲" : "▼";
      });
    }

    function renderTable(){
      elTbody.innerHTML = "";
      state.filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.addEventListener('click', () => openDetail(r.fundo));

        const tdFund = document.createElement('td');
        tdFund.innerHTML = `<span class="chip"><span class="dot"></span><span>${escapeHtml(r.fundo)}</span></span>`;
        tr.appendChild(tdFund);

        const tdP = document.createElement('td');
        tdP.textContent = fmtMoney(r.preco);
        tr.appendChild(tdP);

        const tdRm = document.createElement('td');
        tdRm.textContent = fmtPct(r.ret_m);
        tdRm.className = signClass(r.ret_m);
        t
